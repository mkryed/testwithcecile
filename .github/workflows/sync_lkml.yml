name: Sync .lkml Files

on:
  push:
    branches:
      - master  # Change to the branch you want to trigger the sync on

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Set up Node.js
        uses: actions/setup-node@v2
        with:
          node-version: '16'
          
      - name: Checkout Source Repository
        uses: actions/checkout@v2
        with:
          repository: mkryed/testwithcecile  # Replace with the source repository URL

      - name: Filter .lkml Files with "external"
        run: |
          mkdir filtered_files
          find . -type f -name '*.lkml' -exec grep -l "external" {} + | xargs -I{} cp {} filtered_files/

      - name: Clone Target Repository
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"
          git clone https://${{ secrets.TARGET_TOKEN }}@github.com/mkryed/test_sync_external_files.git target_repository

      - name: Copy Filtered Files to Target Repository
        run: cp -r filtered_files/. target_repository/

      - name: Commit and Push to Target Repository
        working-directory: target_repository
        run: |
          git add .
          git commit -m "Sync .lkml files containing 'external'"
          git push origin main  # Replace with the target branch if needed
